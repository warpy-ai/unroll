interface TestFile {
    name: string;
    path: string;
}

function discoverTests(dir: string, filter: string): TestFile[] {
    let tests: TestFile[] = [];

    discoverTestsRecursive(dir, filter, tests);

    if (fs.existsSync("./src")) {
        discoverTestsInSrc("./src", filter, tests);
    }

    tests = sortTests(tests);
    return tests;
}

function discoverTestsRecursive(dir: string, filter: string, tests: TestFile[]): void {
    if (!fs.existsSync(dir)) {
        return;
    }

    let entries = fs.readdirSync(dir);
    for (let entry of entries) {
        let fullPath = dir + "/" + entry;

        let stats = fs.statSync(fullPath);
        if (stats && stats.isDirectory && stats.isDirectory()) {
            discoverTestsRecursive(fullPath, filter, tests);
        } else if (entry.indexOf(".ot") == entry.length - 3) {
            let name = getTestName(entry);
            if (filter == "" || matchesFilter(name, filter)) {
                tests.push({ name: name, path: fullPath });
            }
        }
    }
}

function discoverTestsInSrc(dir: string, filter: string, tests: TestFile[]): void {
    if (!fs.existsSync(dir)) {
        return;
    }

    let entries = fs.readdirSync(dir);
    for (let entry of entries) {
        let fullPath = dir + "/" + entry;

        let stats = fs.statSync(fullPath);
        if (stats && stats.isDirectory && stats.isDirectory()) {
            discoverTestsInSrc(fullPath, filter, tests);
        } else if (entry.indexOf("_test.ot") == entry.length - 8 || entry.indexOf(".test.ot") == entry.length - 8) {
            let name = getTestName(entry);
            if (filter == "" || matchesFilter(name, filter)) {
                tests.push({ name: name, path: fullPath });
            }
        }
    }
}

function getTestName(filename: string): string {
    // Remove directory path
    let slashIndex = filename.lastIndexOf("/");
    if (slashIndex >= 0) {
        filename = filename.substring(slashIndex + 1);
    }

    // Remove extension
    if (filename.indexOf(".ot") == filename.length - 5) {
        filename = filename.substring(0, filename.length - 5);
    }

    // Remove _test or .test suffix
    if (filename.indexOf("_test") == filename.length - 5) {
        filename = filename.substring(0, filename.length - 5);
    }
    if (filename.indexOf(".test") == filename.length - 5) {
        filename = filename.substring(0, filename.length - 5);
    }

    return filename;
}

function matchesFilter(name: string, filter: string): boolean {
    // Simple glob-style matching
    // * matches any characters

    if (filter == "*") {
        return true;
    }

    // Handle trailing wildcard
    if (filter[filter.length - 1] == "*") {
        let prefix = filter.substring(0, filter.length - 1);
        return name.indexOf(prefix) == 0;
    }

    // Handle leading wildcard
    if (filter[0] == "*") {
        let suffix = filter.substring(1);
        return name.indexOf(suffix) == name.length - suffix.length;
    }

    // Exact match
    return name == filter;
}

function sortTests(tests: TestFile[]): TestFile[] {
    // Simple bubble sort by name
    for (let i = 0; i < tests.length; i = i + 1) {
        for (let j = i + 1; j < tests.length; j = j + 1) {
            if (tests[j].name < tests[i].name) {
                let temp = tests[i];
                tests[i] = tests[j];
                tests[j] = temp;
            }
        }
    }
    return tests;
}

export { discoverTests, TestFile };
